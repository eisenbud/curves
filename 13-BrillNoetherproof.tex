\input{header}

\chapter{Proof of the Brill Noether Theorem}\label{Brill Noether proof chapter}
\label{BrillNoetherproofChapter}

Our goal in this chapter is to give as self-contained as possible a proof of the Brill-Noether theorem. We will focus on proving what we call the ``Basic Brill-Noether" theorem (Theorem~\ref{basic BN}) of Chapter~\ref{Brill-Noether}), which we reproduce here for convenience:

\begin{theorem}[Basic Brill Noether]
If $r\geq 0$ and
 $$
 \rho(g,r,d) := g - (r+1)(g-d+r) \geq 0.
$$
then every smooth projective curve of genus $g$  possesses a $g^r_d$; and for a general curve $C$,  $\dim W^r_d(C) = \rho$. Conversely, if $\rho < 0$ then a general curve $C$ of genus $g$ will not possess a $g^r_d$.
\end{theorem}

In fact, a closer examination of our proof will yield some if not all of the assertions of the stronger Theorems~\ref{Wrd omnibus} and~\ref{grd omnibus}, as well as additional results on the existence of linear series with specified inflectionary behavior; we will discuss these at the end of the current chapter.

%One caveat at the outset: we said that our aim was to give a self-contained proof, and we will fall short of that goal in at least two respects. Our proof is based on Theorem~\ref{osculating intersection} of the last chapter, which involves some elementary intersection theory. And in order to apply Theorem~\ref{osculating intersection}, we need to assert the existence of families of curves specializing from a smooth curve of genus $g$ to a $g$-cuspidal rational curve, which requires us to invoke some elementary deformation theory. \fix{how about families of Pic?}

\section{Castelnuovo's construction}

The idea behind our current proof goes back to Castelnuovo in~\cite{zbMATH02692307}. Castelnuovo's goal was not to prove Brill-Noether, which was considered established at the time (or at least not in need of further demonstration); rather, he asked a follow-up question. If indeed a general curve $C$ of genus $g = 2d-2$ has a finite number of $g^1_d$s, as Brill-Noether asserts, Castelnuovo wanted to know: how many? Note that we have answered this question in cases $g = 2, 4$ and 6, and these cases were certainly known to Castelnuovo, but the case of higher $g$ was unknown.

Castelnuovo's approach to this problem was simple and beautiful, and has informed the proofs of Brill Noether almost a century later. His idea was to specialize a general curve $C$ of genus $g$ to a general $g$-nodal rational curve---that is, a curve $C_0$ with $g$ nodes whose normalization is $\PP^1$---and count the number of $g^1_d$s on that curve. By way of notation, we'll call the nodes of $C_0$ $r_1,\dots,r_g$, and let $p_i, q_i \in \PP^1$ be the two points lying over $r_i$.\footnote{Castelnuovo presented his computation as heuristic, not claiming it was a full proof, and the reviewer of Castelnuovo's paper in the Zentralblatt wrote very politely:
``Das Resultat, welches er bekommen hat, giebt mit grosser Wahrscheinlichkeit den wahren Wert von N \dots; daher sind wir mit dem Verf. einverstanden, wenn er seinen Versuch nicht f체r wertlos h채lt''
(The result that he obtained gives the true value of [the number of $g^1_d$s] with high probability, and thus we agree with the author that his work is not worthless\dots)}

Castelnuovo counted the $g^1_d$s on $C_0$ by observing that any pencil on $C_0$ can be pulled back to a pencil on the normalization $\PP^1$; if we embed $\PP^1$ in $\PP^d$ as a rational normal curve of degree $d$, such a pencil corresponds to a $(d-2)$-plane $\Lambda \subset \PP^d$. Moreover, to say that such a pencil is a pullback from $C_0$ means that every divisor of the pencil that contains $p_i$ contains $q_i$ and vice versa; since the pencil is cut out by hyperplanes in $\PP^d$ containing $\Lambda$, this condition amounts to saying that $\Lambda \cap \overline{p_i,q_i} \neq \emptyset$.

In the Grassmannian $G(d-1, d+1)$ of $(d-2)$-planes in $\PP^d$, the locus of those that meet the line $L_i = \overline{p_i,q_i}$ is what we called in the last chapter the Schubert cycle $\Sigma_1(L_i)$. In these terms, then, the set of $g^1_d$s on our curve $C_0$ is the intersection
$$
W^1_d(C_0) \; = \; \bigcap_{i=1}^{2d-2} \Sigma_1(L_i).
$$

Castelnuovo proposed that if the points $p_i, q_i\in \PP^1$ were chosen generally, then the Schubert cycles
$L_i$ would meet transversely, and thus that the cardinality of this intersection is the power $\sigma_1^{2d-2}$ in the Chow ring $A(G(d-1, d+1))$. Castelnuovo evaluated this power, and came to the conclusion that a general curve $C$ of genus $g=2d-2$ has 
$$
\#W^1_{k+1}(C) \; = \; \frac{(2d-2)!}{(d-1)!d!}
$$
pencils of degree $d$.\footnote{Castelnuovo presented his computation as heuristic, not claiming it was a full proof, and the reviewer of Castelnuovo's paper in the Zentralblatt wrote very politely:
``Das Resultat, welches er bekommen hat, giebt mit grosser Wahrscheinlichkeit den wahren Wert von N \dots; daher sind wir mit dem Verf. einverstanden, wenn er seinen Versuch nicht f체r wertlos h채lt''
(The result that he obtained gives the true value of [the number of $g^1_d$s] with high probability, and thus we agree with the author that his work is not worthless\dots)} Indeed, we have shown
 in Corollary~\ref{secant schubert proper} that if the points $p_i, q_i$ are general, then the Schubert cycles $\Sigma_1(L_i)$ at least intersect properly, so the given number is the number of $g^1_d$ counted with appropriate multiplicities.

%Now, we saw in Corollary~\ref{secant schubert proper} that if the points $p_i, q_i$ are general, then the Schubert cycles $\Sigma_1(L_i)$ intersect properly; if we assume in addition that they intersect transversely, then the cardinality of this intersection is the power $\sigma_1^{2d-2}$ in the Chow ring $A(G(d-1, d+1))$. (Indeed, since the Schubert cycles $\Sigma_1(L_i)$ are hyperplane sections of the Grassmannian in the Pl\"ucker embedding, this is equal to the degree of the Grassmannian.)
%Castelnuovo evaluated this power, and came to the conclusion that a general curve $C$ of genus $g=2d-2$ has 
%$$
%\#W^1_{k+1}(C) \; = \; \frac{(2d-2)!}{(d-1)!d!}
%$$
%pencils of degree $d$.

It was Kleiman who first proposed that Castelnuovo's approach to the study of linear series on a general curve could be used to give a proof of Brill-Noether, if enough care was taken with the specialization arguments. He carried this out in~\cite{Kleiman-special}, and succeeded in reducing the basic Brill-Noether theorem to a special case of Corollary~\ref{secant schubert proper}; this was then proved in~\cite{Griffiths-Harris-BN}.

This is the general approach that we will adopt. However, the relative strength of Theorem~\ref{} and Corollary~\ref{secant schubert proper} suggests specializing to a $g$-cuspidal curve $C_0$ rather than a $g$-nodal one, and we will use
this refinement.

\subsection{Upper bound on the codimension of $W^r_d(C)$}

Let $C$ be a smooth projective curve of genus $g$. We have already indicated how we might arrive at the ``expected" dimension of the locus $W^r_d(C)$ by estimating the dimension of the subvariety $C^r_d \subset C_d$ of divisors moving in an $r$-dimensional linear series; here we'll give a similar argument involving only the Picard variety $\pic(C)$.

Fix a divisor $E = p_1 + \dots + p_m$ of some degree $m > 2g-2-d$ on $C$; for simplicity of notation, we take the points $p_i$ to be distinct. For any invertible sheaf $\cL$ of degree $d$ on $C$, the twist $\cL(E)$ is nonspecial, and so by the Riemann-Roch theorem 
$$
h^0(\cL(E)) = d + m - g + 1.
$$

The pushforward of the Poincar\'e bundle $\cP$ on $\pic_{d+m}(C) \times C$ to $\pic_{d+m}(C)$ is thus a vector
bundle of rank $d + m - g + 1$ whose fibers are the vector spaces $H^0(\cL(E))$. Similarly,
the pushforward ${\pi_1}_*(\cP|_{\pic_{d+m}(C) \times E})$
is a vector bundle whose fibers are the vector spaces $\oplus \cL(E)_{p_i}$. The restriction map
$$
\cP  \rTo \cP|_{\pic_{d+m}(C) \times E}
$$
pushes forward to give a map $\phi : \cE \to \cF$ that on each fiber is the evaluation of sections $\sigma \in H^0(\cL(D))$ at the points $p_i$.

If $\cL$ is an invertible sheaf of degree $d$ then the space $H^0(\cL)$ is the kernel of the map $\phi$ at the corresponding point $\cL(E) \in \pic_{d+m}(C)$, which is given locally by a $d+m \times d+m-g+1$ matrix. The locus $W^r_d(C)$ is a translate of the locus where $\phi$ has rank $d+m-g-r$ or less, and by \cite[****]{Eisenbud1995} this locus is either empty or its components have codimension $\leq (r+1)(g-d+r)$ in $\pic_{d+m}(C)$, which has dimension $g$. Thus \emph{every component of $W^r_d(C)$ has dimension at least $\rho$}.

We can extend this argument in two ways. First, \emph{it applies to families of curves}: if $\cC \to B$ is a family of curves, we can form a corresponding family $\pic_d(\cC / B)$ and a corresponding locus $W^r_d(\cC / B)$, and the conclusion that the codimension of $W^r_d(\cC / B)$ in $\pic_{d+m}(\cC / B)$ is at most $(r+1)(g-d+r)$ everywhere still holds. Thus, for example, if a particular curve $C_0$ had $\dim W^r_d(C_0) = \rho \geq 0$, it would follow that $\dim W^r_d(C_b) = \rho$ for all $b$ in a neighborhood of $0 \in B$. In particular, we could deduce that $W^r_d(C_b)$ was nonempty for all $b$ in a neighborhood of $0 \in B$.

%\fix{need to add that $W^r_d$ is proper, also in families; used in the limit arguments below. (I disagree: $W^r_d(\cC / B)$ is proper only in the smooth case, and I don't believe we ever use it there.}

The second extension is that this set-up also applies  to some singular curves. We are going to see that irreducible curves of arithmetic genus $g$ having nodes and cusps also have Picard varieties, which are irreducible of dimension $g$ (though not in general proper); and if we had a family $\cC \to B$ of curves with, say, $C_b$ smooth for $b \neq 0$ and $C_0$ a $g$-cuspidal curve, then there exists a corresponding family $\pic_d(\cC/B)$ of Picard varieties, and the dimension estimate above applies there as well. This is indeed how we propose to prove the existence of $g^r_d$s on a general curve of genus $g$: we will show that for $\rho \geq 0$ and $C_0$ a $g$-cuspidal curve,  we have $W^r_d(C_0) \neq \emptyset$, and
 $\dim W^r_d(C_0) = \rho(g,r,d)$; from this we can deduce the same statement for a general curve of genus $g$.



%
%\section{The Brill-Noether theorem}
%
%We recall the statement of the basic Brill-Noether theorem from Chapter~\ref{BNChapter}:
%
%\begin{theorem}\label{basic Brill Noether}
%Let $d,g,r$ be non-negative integers, and set 
%$$
%\rho =\rho(g,r,d) := g - (r+1)(g-d+r).
%$$
% \begin{enumerate}
%\item If $\rho \geq 0$, then every curve $C$ of genus $g$ possesses a $g^r_d$.
%\item If $\rho < 0$ then a general curve of genus $g$ does not possess a $g^r_d$.
%\end{enumerate}
%\end{theorem}

%
%%To understand where the number $\rho$ comes from, consider an invertible sheaf $\cL$ of degree $d$ on a curve $C$ of genus $g$. We don't a priori know how many sections $\cL$ will have, but if we fix a divisor $D = \sum p_i$ of degree $e \geq 2g-1-d$ and set $\cM:= \cL(D)$, we do know how many sections $\cM$ will have: since it has degree $d+e > 2g-2$, Riemann-Roch tells us that
%%$$
%%h^0(\cM) = d + e - g + 1.
%%$$
%%To estimate $h^0(\cL)$ we can consider the restriction map
%%$$
%%\rho : H^0(\cM) \to H^0(\cM|_D);
%%$$
%%the kernel of this map is $H^0(\cL)$. Thus,
%%$$
%%h^0(\cL) \geq r+1 \quad \iff \quad \rank(\rho) \leq d+e-g-r.
%%$$
%%
%%Now, let $\cL$ vary in $\Pic_d(C)$. We get a \emph{family} of maps $\rho$ between vector spaces of dimension $d + e - g + 1$ and $e$, parametrized by the Picard variety $\Pic_d(C)$. In general, given a family of maps between vector spaces of dimensions $m$ and $n$, the expected codimension of the locus where the map has rank $k$ or less is $(m-k)(n-k)$; in our present circumstances, this works out to $(r+1)(g-d+r)$. Since the Picard variety has dimension $g$, the expected dimension of $W^r_d(C)$ is then $\rho(g,r,d)$.
%%
%The first part of Theorem~\ref{basic Brill Noether}, often called the ``existence half" of Brill-Noether, was originally proved by Kempf (\cite{Kempf}) and Kleiman-Laksov (\cite{MR323792}) and \cite{MR0357398}. The proofs proceeded essentially by globalizing the construction of the preceding paragraph to express $W^r_d(C)$ as a determinantal scheme associated to a map of vector bundles on $\Pic_d(C)$, calculating the Chern classes of the bundles in question and applying the Thom-Porteous formula to deduce that the determinantal variety was nonempty. A sketch of this argument may  be found in \cite[Appendix D.3]{3264}.  
%
%The second half of Theorem~\ref{basic Brill Noether}---the ``non-existence half"---requires a completely different approach. On the one hand, the condition ``$W^r_d(C) = \emptyset$" is an open condition on $M_g$, so that to prove it one needs only exhibit a single curve with this property. However, as we discuss in Appendix~\ref{Moduli}, it's not possible to write down a general curve of large genus $g$. The curves we can write down explicitly---hyperelliptic curves, trigonal curves, smooth plane curves---tend to be ones that violate Brill-Noether.
%
%We will give here a proof of the second half of Theorem~\ref{basic Brill Noether}, using the Pl\"ucker formula as our essential tool.
%Our proof will use an ingenious construction first suggested by Castelnuovo, which is to consider a family of smooth curves specializing to a $g$-nodal curve. After all, 
%a ``general curve of genus $g$" may be a mysterious object for large $g$, but we can construct nodal curves of arithmetic genus $g$ readily: we just start with $\PP^1$, pick $2g$ distinct points $p_1,\dots,p_g, q_1,\dots,q_g \in \PP^1$, and identify each pair of points $p_i, q_i$ to form a $g$-nodal curve $C_0$. We will see below that there exists a family of smooth curves of genus $g$ specializing to such a curve, and we can analyze linear series on the general member of such a family by considering how they specialize to $C_0$.
%
%Interestingly, Castelnuovo introduced this construction not to prove the Brill-Noether theorem---then considered as established---but to answer an enumerative question: Castelnuovo asked, if a general curve of genus $g = 2k$ has a finite number of $g^1_{k+1}$s, what is the number? As we've seen, for genera $g = 2, 4$ and 6 the answers are 1, 2 and 5 respectively; Castelnuovo used his construction to find the number in general, as we'll describe below. In~\cite{MR435071} it was first proposed that Castelnuovo's construction could be used to prove the Brill-Noether theorem, and carried out the reduction given in Proposition~\ref{} below.
%

\section{Specializing to a $g$-cuspidal curve}

Our first goal is to find a family $\{C_t\}$ of curves of arithmetic genus $g$, with $C_t$ smooth for $t \neq 0$ and $C_0$ a rational curve with $g$ cusps. To do this we show how to construct a rational curve $C_0$ with $g$ cusps; and then we assert that it can be deformed to a smooth curve.

\subsection{Constructing curves with cusps}

This will be a special case of a general construction, informally called ``crimping." We can state the result as

\begin{proposition}
Let $C$ be any curve and $p \in C$ a smooth point. There exists a curve $C_0$ and a bijective morphism $f : C \to C_0$ such that  $f$ maps $C \setminus \{p\}$ isomorphically to $C_0 \setminus \{r\}$ and the image $r=f(p) \in C_0$ is a cusp of $C_0$.
\end{proposition}


\begin{proof}
We can construct $C_0$ explicitly as a topological space homeomorphic to $C$, with structure sheaf $\cO_{C_0}$ that is
the subsheaf of $\cO_C$ consisting of functions on $C$ whose derivative at $p$ is 0.
\end{proof}

Thus, if we start with $\PP^1$, pick any $g$ points $p_1,\dots, p_g \in \PP^1$ and crimp at each $p_i$, we arrive at a $g$-cuspidal curve $C_0$.

For the corresponding result with nodes instead of cusps, see Exercise~\ref{}. 

\subsection{Smoothing a cuspidal curve}  We claim now that if $C_0$ is a curve with a finite number of cusps and no other singularities, then we can smooth $C_0$; that is, we can find a proper flat family $\cC \to \Delta$ with special fiber $C_0$ and all other fibers smooth. 

To begin with, we can do this locally in the complex analytic setting: if $p \in C_0$ is a cusp, we can find an analytic neighborhood of $p$ in which $C_0$ is given by the equation $y^2 = x^3$; we can smooth this by taking the family
$$
y^2 = x^3 + a(t)x + b(t)
$$
where $a$ and $b$ are analytic functions of $t$ with $b'(0) \neq 0$.

The next step is to argue that we can glue together these local smoothings to obtain a proper family $\cC \to \Delta$, and this is where we need to invoke a theorem from deformation theory. The basic fact we need is expressed in the

\begin{lemma}\label{specialization to cuspidal curve}
Let $p_1,\dots,p_g \in \PP^1$ be distinct points, and $C_0$ the curve obtained by 
crimping $\PP^1$ at each $p_i$. There exists a family of curves $\pi : \cC \to B$, where
\begin{enumerate}
\item $B$ is a smooth curve, with distinguished point $0 \in B$;
\item for all $b \neq 0 \in B$, the fiber $C_b = \pi^{-1}(b)$ is a smooth, projective curve of genus $g$;  and
\item the fiber over $0$ is the curve $C_0$.
\end{enumerate}
\end{lemma}


%\fix{Give a reference.
%Ravi sent us references!}


%
%\subsection{$g$-nodal curves}
%Step 1 is to describe ``the curve obtained by identifying pairs of points on $\PP^1$'':
%
%\begin{proposition} \label{Constructing nodal curves}
% Given a (possibly singular) curve $C$ and a pair of distinct smooth points $p,q\in C$, there is a map
% $C\to C_0$ that is an isomorphism away from $p,q$ and identifies $p,q$ in such a way
% that the tangent lines to $C_0$ at $p,q$ are distinct.
%\end{proposition}
%
%\begin{proof}
%We follow the treatment of \cite{Serre1979}
% where a slightly more general case is treated.
% 
%Suppose that $\{ p_1,\dots, p_g, q_1,\dots, q_g  \}$ is a set of $2g$ distinct smooth points on a curve $C$, and let $\pi: C \to C':=C/\sim$ be the set-theoretic quotient of $C$ by the equivalence relation
% $p_i\sim q_i$ for each $i$. Let $r_i\in C'$ be the common image of $p_i, q_i$. We claim that $C'$ can be given the structure of an  algebraic curve with nodes at the points $r_i$, in the sense that the completion satisfies
%$$
%\widehat\cO_{C', r_i} \cong k[[x,y]]/(xy).
%$$
% To prove this we may suppose that the curve $C$ is affine, with coordinate ring $R$.
%For each $i$ we let $\cO_{r_i}$  be the set of germs of sections of $\cO_C$ that are
% defined at both $p_i$ and $q_i$, and have the same value. Thus, regarding everything
% as subsets of the quotient field of $R$, 
% $$
% \cO_{r_i} = k+(\gm_{R,p_i} \cap \gm_{R,q_i}) \subset \cO_{C,p_i}\cap \cO_{C,q_i}.
% $$
% Finally, we set 
% $$
% R' = R \bigcap_{i=1}^g \cO_{r_i}.
% $$
%
%Note that $\cO_{r_i}$ has vector space codimension 1 in 
% $\cO_{C,p_i}\cap \cO_{C,q_i}$, which is the semi-localization of $R$ at
% $\gm_{C,p_i}\cap \gm_{C,q_i}$, the result of inverting every element not in the 
% union of the two maximal ideals. If $f\in R$ is a function vanishing at $p_i, q_i$ but not at $p_j$ or $p_j'$
%then $\cO_{r_j}[f^{-1}$ is strictly bigger than
%$\cO_{r_j}$, and thus $\cO_{r_j} [f^{-1}] = \cO_{C,p_j} \cap \cO_{C,p_j'}$.
%Since localization commutes with finite intersections, we see that $R$ and $R'$
%coincide away from the points $p_i,q_i$, and the local ring $\cO_{C',r_i}$ of $C'$ at $r_i$ is
%equal to $\cO_{r_i}$.
%
%Since $\cO_{C,p_i}\cap \cO_{C,q_i}$ is a finite algebra over $\cO_{C', r_i}$,
%the exact sequence of $\cO_{C', r_i}$-modules
%$$
%0\to \cO_{C', r_i} \to cO_{C,p_i}\cap \cO_{C,q_i} \to k \to 0
%$$
%completes to the exact sequence
%$$
%0\to \widehat\cO_{C', r_i} \to k[[x]]\times k[[y]] \to k \to 0
%$$
%where the last map is the difference of the natural projections
%$k[[x]] \to k$ and $k[[y]] \to k$. Thus
%$\widehat\cO_{C', r_i} \cong k[[x,y]]/(xy)$ as required, completing the construction.
%\end{proof}
%
%
%\subsubsection{Step 2: Castelnuovo's specialization}
%
%Next, Castelnuovo proposed analyzing a family of smooth curves specializing to a $g$-nodal one; in order to use this construction in a proof of Brill-Noether, we have to prove that such families exist. We'll state the lemma we need here:
%
%\begin{lemma}\label{specialization to nodal curve}
%Let $p_1,\dots,p_g, q_1,\dots, q_g \in \PP^1$ be distinct points, and $C_0$ the curve obtained by identifying $p_i$ with $q_i$ for $i = 1,\dots,g$. There exists a family of curves $\pi : \cC \to B$, where
%\begin{enumerate}
%\item $B$ is a smooth curve, with distinguished point $0 \in B$;
%\item for all $b \neq 0 \in B$, the fiber $C_b = \pi^{-1}(b)$ is a smooth, projective curve of genus $g$;  and
%\item the fiber over $0$ is the curve $C_0$.
%\end{enumerate}
%\end{lemma}
%
%This lemma will follow from the local geometry of Severi varieties, as worked out in Chapter~\ref{PlaneCurvesChapter}, and we defer the proof to that chapter.

%\begin{lemma}\label{BN in family}
%If $p_1,\dots,p_g, q_1,\dots, q_g \in \PP^1$ are general points and $\cC \to B$ is a family of curves as described in Lemma~\ref{specialization to nodal curve} above, then for general $b \in B$ the fiber $C_b$ does not possess a $g^r_d$ with $\rho < 0$.
%\end{lemma}
%
%From this, we deduce the basic
%
%\begin{theorem}\label{bare-bones BN}
%A general curve $C$ of genus $g$ does not possess a $g^r_d$ with $\rho(g,r,d) < 0$.
%\end{theorem}

\section{The family of Picard varieties}

Now that we have our family $\cC \to \Delta$ of curves, specializing from a smooth curve of genus $g$ to a $g$-cuspidal curve, the next step in our proof of Brill-Noether will be to relate linear series on the general fiber of our family to their limits on $C_0$.

\subsection{The Picard variety of a nodal or cuspidal curve}

An essential part of our construction is the existence of Picard varieties $\pic_d(C)$ for curves with relatively mild singularities like nodes and cusps. As we indicated, we're going to want to apply this to a $g$-cuspidal curve, but it's true for curves with both nodes and cusps; here we'll describe the Picard variety of an irreducible curve $C_0$ of arithmetic genus $g$ having a total of $g$ nodes and cusps (so that the normalization $\widetilde C \cong \PP^1$).

To start, let $C$ be a curve with a node $p$, and $\widetilde C \rTo^\nu C$ the normalization of $C$ at $p$; we'll denote by $q,r \in \widetilde C$ the points lying over $p$. If $\cL$ is an invertible sheaf on $C$, and $\cM := \nu^*(\cL)$ the pullback of $\cL$ to $\widetilde C$, then $\cM$ is an invertible sheaf on $\widetilde C$. Its fibers over $q$ and $r$ are both identified with the fiber $\cL_p$ of $\cL$ at $p$, and hence with each other. Conversely, given an invertible sheaf $\cM$ on $\widetilde C$ and an identification of the fibers $\cM_q$ and $\cM_r$, we can form an invertible sheaf $\cL$ on $C$ by taking the subsheaf of $\nu_*\cM$ whose sections ``agree" at $q$ and $r$, in terms of the identification. 

Thus the family of invertible sheaves $\cL$ on $C$ whose pullback is isomorphic to a given $\cM$ may be identified with the set of isomorphisms $\cM_q \cong \cM_r$ of the two one-dimensional vector spaces $\cM_q$ and $\cM_r$, so that  we have an exact sequence of groups
$$
0 \rTo  \CC^* \rTo \pic_0(C) \rTo^{\nu^*}  \pic_0(\widetilde C) \rTo 0
$$
and similarly for $\pic_d$ for any degree $d$.

One way to express this---which will apply as well in the cuspidal case---is that \emph{the data of an invertible sheaf $\cL$ on $C$ is equivalent to the data of an invertible sheaf $\widetilde \cL$ on $\widetilde C$, together with a trivialization of $\widetilde \cL$ on the preimage $\nu^{-1}(p)$ up to scalar multiplication}.


\def\wL{{\widetilde\sL}}

Similarly, suppose that $p\in C$ is a cusp and $\pi: \widetilde C \to C$ is the normalization of $C$ at $p$; denote by $q$ the preimage of $p$ in $\widetilde C$. Now the preimage $\nu^{-1}(p)$ is the nonreduced scheme $2q \subset \widetilde C$, but the principle stated above still holds: the data of an invertible sheaf $\cL$ on $C$ is equivalent to the data of an invertible sheaf $\widetilde \cL$ on $\widetilde C$, together with a trivialization of $\widetilde \cL$ on the preimage $\nu^{-1}(p)$ up to scalar multiplication. In this case, the family of such trivializations, mod scalars, in parametrized by $\CC$; so we have an exact sequence 
$$
0 \rTo \CC \rTo \pic_0(C) \rTo^{\nu^*} \pic_0(\widetilde C) \rTo 0.
$$


%
%Suppose that
%$\sL$ is an invertible sheaf on $C$, and let $\wL = \pi^*(\sL) = \sO_{\widetilde C}\otimes_{\sO_C} \sL$ be its pullback to $\widetilde C$. The inclusion $\gm_{C,p}\subset \sO_C \subset \pi_*(\sO_{\widetilde C})$ induces proper inclusions
%$$
%\gm_{C,p}\wL  = \wL(-2p) \subset \sL \subset \wL;
%$$
%where for simplicity we have written $p$ again for the preimage of $p$ in $\widetilde C$ and $\wL$ in place of $\pi_*(\wL)$.
%This is the same as saying that local sections of $\sL$ may be identified with the local sections of $\wL$ that
%are either units or vanish to order 2 at $p$.
%
%Fixing the sheaf $\wL\in \Pic_0(\widetilde C)$ we note that  $\wL/\wL(-2p) \cong \CC[x]/(x^2)$. The 1-dimensional subspaces of $\CC[x]/(x^2)$ that contain a unit
%are those of the form $\CC(1+rx)$ for $r\in \CC$. Identifying the image of a local generator of $\sL$ in $\wL/\wL(-2p)$
% with $1\in \CC[x]/(x^2)$, we see that there are invertible sheaves $\sL_r$ on $C$ whose local generator
% at $p$ goes to $1+rx\in \CC[x]/(x^2)$. These are non-isomorphic on $C$ because
% any isomorphism would induce an automorphism of $\wL(-2)$, and such an automorphism would be given by multiplication
% with an element of $\CC^*$. Once again, these are sheaves that become isomorphic when restricted to the
% complement of $p$ (since they are isomorphic as sheaves on $\widetilde C$. Thus we have an exact sequence 
%$$
%0 \rTo \CC \rTo \pic_0(C) \rTo^{\nu^*} \pic_0(\widetilde C) \rTo 0,
%$$
%and similarly for $\Pic_d$.

% If the curve $C$ has a cusp at $p$, the analogue of the class of identifications $\cM_q \cong \cM_r$ above is an equivalence class of trivializations of the invertible sheaf $\cM$ over the preimage $\nu^{-1}(p) \subset \widetilde C$, where two trivializations are equivalent if they differ by multiplication by a constant. Stated that way, the same conclusion holds if $\nu : \widetilde C \to C$ is the normalization of a curve $C$ at a cusp $p$; the difference is that the preimage $\nu^{-1}(p)$ is a nonreduced scheme isomorphic to $\Spec \CC[\epsilon]/(\epsilon^2)$ rather than two reduced points. In this case, the family of equivalence classes of trivializations of $\cM$ over $\nu^{-1}(p)$ is a copy of $\CC$ rather than $\CC^*$, and we have correspondingly an 
 


In the case of the curves we'll be dealing with, we can say that for a $g$-cuspidal curve $C$,
$$
\pic_0(C) \; \cong \CC^g
$$
and for a $g$-nodal curve $C$, 
$$
\pic_0(C) \; \cong (\CC^*)^g.
$$
Note that both of these are irreducible of dimension $g$, just like the Picard variety of a smooth curve of genus $g$. In neither case, however, is $\pic_0(C)$ proper. We will deal with this fact in Section~\ref{line bundle limits} below.

\subsection{The relative Picard variety}

%\fix{the next para should  be factified in the Jacobian chapter where we state the existence of Pic_d in a cheerful fact.} 
As before, let $\pi : \cC \to \Delta$ be a family of curves of arithmetic genus $g$, with fiber $C_t = \pi^{-1}(t)$ a smooth curve of genus $g$ and $C_0$ a $g$-cuspidal curve. The Picard varieties $\Pic(C_t)$ form a family $\pic(\cC/\Delta)$, and the varieties $W^r_d(C_t)$ form a subfamily $\cW^r_d(\cC/\Delta)$. Furthermore, the codimension of $\cW^r_d(\cC/\Delta) \subset \pic(\cC/\Delta)$ is $\leq (r+1)(g-d+r)$ everywhere. In the argument bounding  the dimensions of the $W^r_d$
we may replace the points $p_i$ by sections of the family.

But if our goal is to say something about the varieties $W^r_d(C_t)$ by studying the fiber of $\cW^r_d(\cC/\Delta)$ over $t=0$, we have a problem: as we've noted, the map $\cW^r_d(\cC/\Delta) \to \Delta$ is not proper, so it is a priori possible that the fiber of $\cW^r_d(\cC/\Delta)$ over $t=0$ is empty, whatever the geometry of $W^r_d(C_t)$ for $t \neq 0$. In other words,  if we're going to analyze linear series on the general curve of our family $\{C_t\}$ of smooth curves specializing to a $g$-cuspidal or $g$-nodal curve by taking limits, we have to describe the possible limits of linear series on $C_t$ as $t\to 0$; we will take this up in the next section.

%\fix{The following Lemma was in the commented-out "bits and pieces". We need to apply it with a cuspidal limit, in the end.
%also, we need to say why the relative picard scheme construction allows us to find a family of $g^r_d$s on
%such a family if the individual smooth curves have them. Also, we have to decide whether to add one node at a time
%or go for all g nodes at once.}
%
%\begin{lemma}\label{specialization to nodal curve}
%Let $p_1,\dots,p_g, q_1,\dots, q_g \in \PP^1$ be distinct points, and $C_0$ the curve obtained by identifying $p_i$ with $q_i$ for $i = 1,\dots,g$. There exists a family of curves $\pi : \cC \to B$, where
%\begin{enumerate}
%\item $B$ is a smooth curve, with distinguished point $0 \in B$;
%\item for all $b \neq 0 \in B$, the fiber $C_b = \pi^{-1}(b)$ is a smooth, projective curve of genus $g$;  and
%\item the fiber over $0$ is the curve $C_0$.
%\end{enumerate}
%\end{lemma}
%
%This lemma will follow from the local geometry of Severi varieties, as worked out in Chapter~\ref{PlaneCurvesChapter}, and we defer the proof to that chapter.

%\fix{what I think we need instead or in addition:}

\begin{lemma}\label{specialization to cuspidal curve}
Let $p_1,\dots,p_g \in \PP^1$ be distinct points, and $C_0$ the curve obtained by 
crimping $\PP^1$ at each $p_i$. There exists a family of curves $\pi : \cC \to B$, where
\begin{enumerate}
\item $B$ is a smooth curve, with distinguished point $0 \in B$;
\item for all $b \neq 0 \in B$, the fiber $C_b = \pi^{-1}(b)$ is a smooth, projective curve of genus $g$;  and
\item the fiber over $0$ is the curve $C_0$.
\end{enumerate}
\end{lemma}

%\fix{this needs a proof -- not refer to Severi scheme but rather to the local comp plus Ravi's references}

\subsection{Limits of line bundles}\label{line bundle limits}

%\fix{This subsection is extremely confusing. I'd suggest scrapping it entirely and talking about how to state (and prove) what we need.}

%Given a family $\pi : \cC \to B$, and a family $\{ \cD_b = (L_b, V_b)\}_{b \neq 0 \in B}$ of linear series on the curves $C_b$ with $b \neq 0$, how can we describe the ``limit" of the linear series $\cD_b$ as $b \to 0$? The answers are similar whether the special fiber $C_0$ has nodes or cusps, so we'll give the answer in both cases. 

Suppose that $0\in B$ is a point of a smooth curve, and that  $\pi : \cC \to B$ is a family of smooth genus $g$ curves specializing to a (necessarily rational) curve $C_0$ with a total of $g$  nodes and cusps. as in Lemma~\ref{specialization to nodal curve}. 
 Let 
$$
\pi^\circ: \cC^\circ := \cC \setminus C_0\to B^\circ := B\setminus 0.
$$
and suppose that there is a line bundle $\cL^\circ$ on $\cC^\circ$ such that $h^0(\cL^\circ|_{C_b}) \geq r+1$ for each $b \neq 0 \in B$. 
We can extend $\cL^\circ$  to a rank 1 torsion-free sheaf on all of $\cC$. 


\begin{lemma}\label{limit sheaf}
In the situation above, there exists a torsion-free sheaf $\cL$ of rank 1 on all of $\cC$, locally isomorphic to
an ideal sheaf of $\cC$, such that $\cL|_{\cC^\circ} \cong \cL^\circ$.
\end{lemma}

In fact, any torsion free sheaf of rank 1 is locally isomorphic
to an ideal sheaf; this follows from the fact that $\cC$ is generically Gorenstein. However, the argument we give 
shows directly that the extension is isomorphic to an ideal sheaf tensored with an invertible sheaf, and the fact that
it is locally isomorphic to an ideal sheaf follows at once.

\begin{proof} Choose an auxiliary line bundle $\cM$ on $\cC$ with relative degree $e > d + 2g$ and let $\cM^\circ$ be the restriction of $\cM$ to $\cL^\circ$. Consider the line bundle 
$$
\cN^\circ = (\cL^\circ)^* \otimes \cM^\circ.
$$
%The bundle $\cN^\circ$ has lots of sections: the direct image, as a sheaf on $B$, is locally free of rank $e-g+1 > 0$, and after restricting to an open neighborhood of $0 \in B$ we can assume it's generated by them \fix{This seems to require that the
%original fibers had exactly $r+1$ independent sections. Also, we are still in a punctured neighborhood of $b$, so this might need some further argument}. 
Choose a section $\sigma$ of $\cN^\circ$; let $D^\circ \subset \cC^\circ$ be its divisor of zeros, and let $D \subset \cC$ be the closure of $D^\circ$ in $\cC$. 

Away from $C_0$ we can write
$$
\cL^\circ = (\cN^\circ)^* \otimes \cM^\circ = \cI_{D^\circ/\cC^\circ} \otimes \cM^\circ
$$
and accordingly the sheaf
$$
\cL := \cI_{D/\cC} \otimes \cM
$$
has the desired properties. 
\end{proof}

%Even if the family we originally started with had smooth total space, the base change called for in the first step would yield a family $\cC$ with  total space singular at the nodes of $C_0$. If $D$ passes through any of these points it need not be Cartier, 
%so $\cL|_{C_0}$, though torsion-free, may not be invertible.
%
%In sum, if the general fiber $C_b$ of our family has a $g^r_d$, we can conclude that the special fiber $C_0$ has a torsion-free sheaf $\cL_0$ with 
%$$
%c_1(\cL_0) = d;
%$$
%\fix{where did the reader learn about Chern classes of torsion-free sheaves?? Might be better to say degree and explain what that means for a torsion-free sheaf.}
%and, by upper-semicontinuity of cohomology,
%$$
%h^0(\cL_0) \geq r+1.
%$$

%\fix{clarify that this is locally iso to an ideal, though maybe not globally}
Fortunately the ideal sheaves on nodal and cuspidal curves have a simple local structure. The reason lies in the relation of $R$ to its integral closure. 

\begin{definition}
The \emph{conductor} of an integral domain $R$ is the annihilator of the $R$-module
$\widetilde R/R$, where $\widetilde R$ is the integral closure of $R$.
\end{definition}

It follows at once from the definition that the conductor of $R$ is also an ideal of $\widetilde R$, and that it is the largest such ideal. The following result is a restatement of examples 1 and 2 after Proposition~\ref{Leray}:
%\fix{introduce the word conductor in Ch 2 where this is done}

\begin{proposition}\label{conductor of node and cusp}
If $R$ is the local ring of an node or ordinary cusp singularity of a curve, then  $\widetilde R/R \cong k$, the residue field of $R$, and thus the conductor of $R$ is the
maximal ideal. \qed
\end{proposition}

\begin{proof} These properties can be verified after completing at the maximal ideal of $R$.
To say that $R$ has an node singularity means that the completion of $R \subset \widetilde R$ at the maximal ideal $\gm$ of $R$ is $k[[x,y]]/(xy)\subset k[[x]]\times k[[y]]$. Since  $k[[x,y]]/(xy)$ contains every $x^n$ and $y^n$ with $n>0$,
$(x,y) (k[[x]]\times k[[y]]) \subset k[[x,y]]/(xy)$, so 
$(k[[x]]\times k[[y]])/ k[[x,y]]/(xy) \cong k$.

Similarly, to say that $R$ has an ordinary cusp singularity means that the completion of 
$R \subset \widetilde R$ is $k[[x^2,x^3]]\subset k[[x]]$, and the quotient is $kx \cong k$.
\end{proof}

%\fix{I changed torsion-free sheaf to ideal sheaf. While it's true that any torsion-free sheaf of rank 1 over
%a generically Gorenstein ring is an ideal
%sheaf, there are subtleties that I think are best avoided.}

\begin{theorem}\label{torsion free at node}
Let $p$ be an node or ordinary cusp of a curve $C$ with normalization $\pi: \widetilde C \to C$. Let $R = \sO_{C,p}$ be the local ring of the singular point,
and let $\widetilde R$ be its normalization.  If $\cF$ is an ideal sheaf on $C$, then in a neighborhood of $p$ in $C$ the sheaf $\cF$ is either locally free or locally isomorphic to the ideal sheaf $\cI_{p/C}$ of $p$ in $C$. In the latter case,
writing $\gm$ for the maximal ideal of $R$,
there is a split exact sequence
$$
0\to \widetilde R/\gm \widetilde R \to \cI_{p/C} \otimes \widetilde R  \to \cI_{p/C} \widetilde R\to 0
$$
with $\cI_{p/C} \widetilde R \cong \widetilde R$.
\end{theorem}

Interpreting the Theorem in the context of sheaves, we get

\begin{corollary}
Suppose that $C$ is an integral curve with a cusp or node at $p\in C$, and $\pi:\widetilde C \to C$ is the
the partial normalization of $C$ at $p$, so that $p_a(\widetilde C) = p_a(C) -1$. If $\sF$ is isomorphic to an ideal sheaf on $C$
and $\sF$ is not locally free at $p$, then there is a unique locally free sheaf $\widetilde \sF$ on $\widetilde C$
with a surjective map $\pi^*(\sF) \to \widetilde\sF$ inducing a monomorphism $H^0(\sF) \to H^0(\widetilde\sF)$
with $\chi(\widetilde \sF) = \chi(\sF) -2$ and thus 
$$
\deg \widetilde \sF = \chi(\widetilde \sF) - \chi(\widetilde \sO_{\widetilde C}) = 
\deg(\sF)-1.
$$
\qed
\end{corollary}
%\fix{did we ever define degree this way -- will be in Ch 2}

\begin{proof}[Proof of Theorem~\ref{torsion free at node}] We may work over the local ring $R := \cO_{C,p}$, and replace $\cF$ with 
its localization $I\subset R$ at $p$. Write
$\gm$ for the maximal ideal of $R$ which, by Proposition~\ref{conductor of node and cusp}, is also an ideal of $\widetilde R$.
We must show that $I$ is isomorphic as an $R$-module to either $R$ or $\gm$.

\def\sEnd{{\sE \kern-1pt nd}}

Consider the endomorphism ring of $I$, and note that it is commutative, contains $R$,  and is integral over $R$ so 
$$
R \subset \sEnd(I) \subset \widetilde R.
$$
Since
$\widetilde R/R \cong k$, the ring $\sE nd(I)$ is equal to either 
$R$ or $\widetilde R$. 

First, suppose
$\sEnd(I)=\widetilde R$, which is a 1-dimensional regular ring---a discrete valuation ring in the case of a cusp
or a ring with two maximal ideals in the case of a node. In either case, every ideal of $\widetilde R$ is principal.
 Since $I$ is torsion-free, it is free as an 
$\widetilde R$-module, and has rank 1. Since $\gm$ is also an ideal of $\widetilde R$, it is isomorphic to $\widetilde R$
as $\widetilde R$-module, and since $R\subset \widetilde R$,
$I \cong \gm$ as $R$-modules.

On the other hand., suppose
$\sEnd(I)=R$.
 and consider the inclusions
$$
\gm I \subset I \subset \widetilde R I.
$$
%We have
%$$
%\gm I = (\gm \widetilde R) I =  \gm (\widetilde R I) \cong \gm \widetilde R \cong \widetilde R.
%$$
%Thus
%$$
%\gm I \subset I \subset \widetilde R.
%$$
The left and right hand modules both have endomorphism ring $\widetilde R$,
so both containments must be strict. Since $\widetilde R/\gm$ has length 2,
we see that $I/\gm I$ is principal, so $I\cong R$.
\end{proof}

To summarize the situation so far: if we assume that the general curve $C_t$ of our family has a $g^r_d$, we may conclude that the $g$-cuspidal curve $C_0$ has a torsion-free sheaf $\cL_0$ of degree $d$ with at least $r+1$ sections. 
%\fix{this requires an argument we haven't given, which will use the base-change theorem or semi-cont of coho.} 
Moreover, at each node $r_i$ of $C_0$, $\cL_0$ is either locally free or isomorphic to the maximal ideal. Thus, if we denote by $p_1,\dots, p_k$ the cusps of $C_0$ at which $\cL_0$ is isomorphic to the maximal ideal, and let $\widetilde C_0$ be the normalization of $C_0$ at those cusps, then $\widetilde C_0$ will be a curve of arithmetic genus $g-k$ having $g-k$ cusps, and
the pullbacks to $\widetilde C_0$ of the sections of $\cL_0$ give us a $g^r_d$ on $\widetilde C_0$ with base points at the points lying over $r_1,\dots,r_k$; equivalently, this is a $g^r_{d-k}$ on the $(g-k)$-cuspidal curve  $\widetilde C_0$.



\section{Putting it all together}

\subsection{Non-existence}

We claim here that \emph{a general curve of genus $g$ does not posses a $g^r_d$ with $\rho(g,r,d) < 0$}.
Here we use Theorem~\ref{osculating intersection} from the last chapter, which implies exactly this statement for a $g$-cuspidal curve $C_0$. By what we said above, if it were indeed the case that a general curve possessed a $g^r_d$ with $\rho(g,r,d) < 0$, then we could produce for some $k \geq 0$ a $g^r_{d-k}$ on a $(g-k)$-cuspidal curve  $\widetilde C_0$. But since
$$
\rho(g-k, r, d-k) = \rho(g,r,d) - k < 0
$$
this is impossible.

\subsection{Existence}

Once more we let $\cC \to \Delta$ be a family of smooth curves specializing to a $g$-cuspidal curve $C_0$. We can use Corollary~\ref{intersection with sigma nonzero} in combination with Theorem~\ref{osculating intersection} to say that the variety $W^r_d(C_0)$ is nonempty of dimension $\rho(g,r,d)$; since the codimension of $\cW^r_d(\cC/\Delta) \subset \pic_d(\cC/\Delta)$ is at most $(r+1)(g-d+r)$ everywhere, we may conclude that likewise for general $t$ the variety $W^r_d(C_t)$ is nonempty of dimension $\rho(g,r,d)$.


%\fix{The next few pages are a hodgepodge of bits and pieces of arguments that were relevant at some point. I'm keeping them around on the off-chance that some of them may be useful, but basically it all need to be rewritten in the context of the argument sketched in the section headings above}
%
%\subsubsection{Step 3: The Altman-Kleiman analysis}
%
%The analysis proposed by Altman and Kleiman considers the question: given a family $\pi : \cC \to B$, and a family $\{ \cD_b = (L_b, V_b)\}_{b \neq 0 \in B}$ of linear series on the curves $C_b$ with $b \neq 0$, how can we describe the ``limit" of the linear series $\cD_b$ as $b \to 0$? 
%
%To set this up, suppose now we have a family $\pi : \cC \to B$ as in Lemma~\ref{specialization to nodal curve}, and suppose that the general curve $C_b$ in the family does have a line bundle $\cL_b$ of degree $d$ with $r+1$ sections. Finally, let 
%$$
%\pi^\circ: \cC^\circ := \cC \setminus C_0\to B^\circ := B\setminus 0.
%$$
%and suppose that the line bundles $\cL_b$ fit together to form a line bundle on $\cC^\circ$; that is, there exists a line bundle $\cL^\circ$ on $\cC^\circ$ with $h^0(\cL^\circ|_{C_b}) = r+1$ for each $b \neq 0 \in B$. 
%
%The next step is to try to extend the line bundle $\cL^\circ$ on $\cC^\circ$ to a line bundle on all of $\cC$. We can't necessarily do this, but we do have a ``next best" thing: we can extend $\cL^\circ$  to a torsion-free sheaf on all of $\cC$.
%
%
%
%\begin{lemma}
%There exists a torsion-free sheaf $\cL$ of rank 1 on all of $\cC$ such that $\cL|_{\cC^\circ} \cong \cL^\circ$.
%\end{lemma}
%
%\begin{proof} To start, we choose an auxiliary line bundle $\cM$ on $\cC$ with relative degree $e > d + 2g$ and let $\cM^\circ$ be the restriction of $\cM$ to $\cL^\circ$. Consider the line bundle 
%$$
%\cN^\circ = (\cL^\circ)^* \otimes \cM^\circ.
%$$
%%The bundle $\cN^\circ$ has lots of sections: the direct image, as a sheaf on $B$, is locally free of rank $e-g+1 > 0$, and after restricting to an open neighborhood of $0 \in B$ we can assume it's generated by them \fix{This seems to require that the
%%original fibers had exactly $r+1$ independent sections. Also, we are still in a punctured neighborhood of $b$, so this might need some further argument}. 
%Choose a section $\sigma$ of $\cN^\circ$; let $D^\circ \subset \cC^\circ$ be its divisor of zeros, and let $D \subset \cC$ be the closure of $D^\circ$ in $\cC$. Now, away from $C_0$ we can write
%$$
%\cL^\circ = (\cN^\circ)^* \otimes \cM^\circ = \cI_{D^\circ/\cC^\circ} \otimes \cM^\circ
%$$
%and accordingly the sheaf
%$$
%\cL := \cI_{D/\cC} \otimes \cM
%$$
%is the desired sheaf. 
%\end{proof}
%
%%Even if the family we originally started with had smooth total space, the base change called for in the first step would yield a family $\cC$ with  total space singular at the nodes of $C_0$. If $D$ passes through any of these points it need not be Cartier, 
%%so $\cL|_{C_0}$, though torsion-free, may not be invertible.
%%
%%In sum, if the general fiber $C_b$ of our family has a $g^r_d$, we can conclude that the special fiber $C_0$ has a torsion-free sheaf $\cL_0$ with 
%%$$
%%c_1(\cL_0) = d;
%%$$
%%\fix{where did the reader learn about Chern classes of torsion-free sheaves?? Might be better to say degree and explain what that means for a torsion-free sheaf.}
%%and, by upper-semicontinuity of cohomology,
%%$$
%%h^0(\cL_0) \geq r+1.
%%$$
%
%Thus the ``limit" of the line bundles $\cL_b$ may not be an invertible sheaf, but only a torsion-free sheaf of rank 1. Fortunately the torsion-free sheaves on nodal curves have a simple structure. The reason lies in the relation of $R$ to its integral closure:
%
%\begin{definition}
%The \emph{conductor} of an integral domain $R$ is the annihilator of the $R$-module
%$\widetilde R/R$, where $\widetilde R$ is the integral closure of $R$.
%\end{definition}
%
%It follows at once from the definition that the conductor of $R$ is also an ideal of $\widetilde R$, and that it is the largest such ideal.
%
%\begin{proposition}
%If $R$ is the local ring of an node or ordinary cusp singularity of a curve, then  $\widetilde R/R \cong k$, the residue field of $R$, and thus the conductor of $R$ is the
%maximal ideal. 
%\end{proposition}
%
%\begin{proof} These properties can be verified after completing at the maximal ideal of $R$.
%To say that $R$ has an node singularity means that the completion of $R \subset \widetilde R$ at the maximal ideal $\gm$ of $R$ is $k[[x,y]]/(xy)\subset k[[x]]\times k[[y]]$, and 
%the annihilator of $k[[x]]\times k[[y]]/k[[x,y]]/(xy) \cong k$ is clearly $(x,y)$, the ideal generated by $\gm$.
%
%Similarly, to say that $R$ has an ordiinary cusp singularity means that the completion of 
%$R \subset \widetilde R$ is $k[[x^2,x^3]]\subset k[[x]]$, and again the quotient is $k$.
%\end{proof}
%
%\begin{lemma}\label{torsion free at node}
%Let $p$ be an node or ordinary cusp of a curve $C$. Let $R = \sO_{C,p}$ be the local ring of the singular point,
%and let $\widetilde R$ be the normalization.  If $\cF$ is a torsion-free sheaf on $C$, then in a neighborhood of $p$ in $C$ the sheaf $\cF$ is either locally free or locally isomorphic to the ideal sheaf $\cI_{p/C}$ of $p$ in $C$.
%In the latter case, the pullback to the normalization is isomorphic to $\widetilde R\oplus \kappa(p) \oplus \kappa(q)$.
%\end{lemma}
%
%\begin{proof} We may work over the local ring $R := \cO_{C,p}$, and replace $\cF$ with 
%its localization $I\subset R$ at $p$ as well. We write
%$\gm$ for the maximal ideal of $R$
%
%Consider the endomorphism ring of $I$, and note that it is commutative and integral over $R$ so 
%$$
%R \subset \End I \subset \widetilde R.
%$$
%Since
%$\widetilde R/R \cong k$, the ring $\End(I)$ is equal to either 
%$R$ or $\widetilde R$. 
%
%First, suppose
%$\End(I)=\widetilde R$, which is a discrete valuation ring.
% As an 
%$\widetilde R$-module, $I$ is free of rank 1.  The conductor
%$\ann(\widetilde R/R)$ is $\gm$.
%Since the conductor is also an ideal of $\widetilde R$, and thus isomorphic to $\widetilde R$
%as $\widetilde R$-module,
%we see that $I \cong \gm$ as $R$-modules.
%
%Now suppose
%$\End(I)=R$, and consider the inclusions
%$$
%\gm I \subset I \subset \widetilde R I.
%$$
%Since $\gm$ is the conductor of $R$, it is also an ideal of $\widetilde R$, so
%$\gm I = \gm \widetilde R I$. On the other hand, $\widetilde R I$ is an ideal of $\widetilde R$,
%and as such is principal, so it is isomorphic as an $R$-module to $\widetilde R$. Thus, up to 
%isomorphism, the inclusions above become
%$$
%\gm I = \gm \widetilde R \subset I \subset \widetilde R.
%$$
%The left and right hand modules both have endomorphism ring $\widetilde R$,
%so both containments must be strict. Since $\widetilde R/\gm$ has length 2,
%we see that $I/\gm I$ is principal, so $I\cong R$.
%\end{proof}
%
%To summarize the situation so far: if we assume that the general curve $C_b$ of our family has a $g^r_d$, we may conclude that the $g$-nodal curve $C_0$ has a torsion-free sheaf $\cL_0$ of degree $d$ with at least $r+1$ sections. Moreover, at each node $r_i$ of $C_0$, $\cL_0$ is either locally free or isomorphic to the maximal ideal. 
%
%Finally, suppose that $\cL_0$ is locally free at the nodes $r_1,\dots, r_{g'}$ and isomorphic to the maximal ideal at the nodes $r_{g'+1},\dots,r_g$. In this case, we can pull $\cL_0$ back to the partial normalization $\widetilde C$ of $C_0$ at the nodes $r_{g'+1},\dots,r_g$; in this case we arrive at an invertible sheaf of degree $d-(g-g')$ on the $g'$-nodal curve $\widetilde C$ having at least $r+1$ sections.

%\begin{exercise}
% The proof above works whenever $R$ is a local domain with integral closure $\widetilde R$ and the conductor
% $\ann \widetilde R/R = \gm$,
% the maximal ideal of $R$. Show that this is the case for nodes and cusps, but not for any other curve singularities.
%\end{exercise}

%\begin{exercise}
%\begin{enumerate}
%\item Show  that the conclusion of Lemma~\ref{torsion free at node} holds in case $p$ is a node of $C$
%\item Show by example that the conclusion of Lemma~\ref{torsion free at cusp} is false in case $p$ is either a tacnode or a triple point of $C$.
%\end{enumerate}
%\end{exercise}
%
%
%
%\subsubsection{Step 4: The reduction to Schubert calculus}
%
%The point of the argument thus far has been to reduce a problem involving linear series on a smooth curve---that is, a line bundle of degree $d$ with $r+1$ global sections---to one involving sections of a torsion-free sheaf on a $g$-nodal curve. Why is this an improvement? 
%
%The answer is, if we have a linear system on a $g$-nodal curve $C_0$, we can look at its pullback to the normalization $\PP^1$ of $C_0$, where we understand the geometry of linear systems much better. To see how this goes, suppose that as above we have a family $\cC \to B$ of curves specializing from a smooth curve of genus $g$ to a $g$-nodal curve $C_0$. Suppose  that we have a linear series $\cD_b = (\cL_b, V_b)$ of degree $d$ and dimension $r$ on the smooth fibers $C_b$. In addition, suppose for the moment that the family of line bundles $\cL_b$ extends to a line bundle on all of $\cC$. (Of course, once we've done this we'll double back and consider what happens if the limit of $\cL_b$ is torsion-free but not locally free.) What has this reduction bought us?
%
%Quite a lot, actually. The point is, if $\cL_0$ is a line bundle of degree $d$ on the $g$-nodal curve $C_0$, and $\nu : \PP^1 \to C_0$ the normalization map, the pullback $\nu^*\cL$ is the line bundle $\cO_{\PP^1}(d)$; and if $V_0 \subset H^0(\cL_0)$ is an $(r+1)$-dimensional vector space of sections of $\cL_0$, then the pullback $\nu^*(V_0)$ is  an $(r+1)$-dimensional subspace of $H^0(\cO_{\PP^1}(d))$. There are of course a lot of these---if we imagine $\PP^1$ as embedded in $\PP^d$ by the complete linear series $|\cO_{\PP^1}(d)|$, they correspond exactly to linear spaces $\Lambda \cong \PP^{d-r-1} \subset \PP^d$, so that we have a Grassmannian of them. The question is, \emph{when is the $g^r_d$ on $\PP^1$ associated to a linear space $\Lambda \subset \PP^d$ the pullback of a $g^r_d$ on $C_0$}?
%
%The answer is straightforward: in order for a linear series on $\PP^1$ to be the pullback of a linear series on $C_0$, it has to be the case that for each $i = 1,\dots, g$, every divisor of the linear series containing $p_i$ must also contain $q_i$ and vice versa. In terms of the geometry of the linear space $\Lambda \subset \PP^d$, this is tantamount to saying that \emph{$\Lambda$ must intersect the secant line $\overline{p_i,q_i}$ to the rational normal curve $\PP^1 \subset \PP^d$ for each $i=1,\dots,g$}.
%
%Do we expect there to exist linear spaces $\Lambda \cong \PP^{d-r-1} \subset \PP^d$ meeting each of $g$ general chords to a rational normal curve? To answer this, we can make a dimension count. To start, the Grassmannian $\GG(d-r-1,d)$ has dimension $(r+1)(d-r)$. Next, for a given line $L \subset \PP^d$, the locus of $(d-r-1)$-planes $\Lambda \subset \PP^d$ meeting $L$ is a Schubert cycle, denoted $\Sigma_r(L)$; it has codimension $r$ in $\GG(d-r-1,d)$. \emph{If}  the Schubert cycles $\Sigma_r(\overline{p_i,q_i})$ associated to $g$ general chords to the rational normal curve in $\PP^d$ intersect dimensionally transversely, this will be the case only if
%$$
%rg \leq (r+1)(d-r),
%$$
%which is exactly the condition $\rho(g,r,d) \geq 0$.
%
%We must also consider the case when the limit $\cL_0$ of the line bundles $\cL_b$ in our family is not locally free at some subset $r_1, \dots, r_\delta$ of the nodes of $C_0$. In this case, let $\widetilde C_0$ be the partial normalization of $C_0$ at these nodes, and $\widetilde \nu : \widetilde C_0 \to C_0$ the partial normalization map, so that $\widetilde C_0$ is the ($g-\delta$)-nodal curve obtained by identifying $g-\delta$ pairs of general points on $\PP^1$. The pullback $\widetilde \nu^*(\cL_0)$ is  locally free of degree $d-2\delta$ on $\widetilde C_0$, so that an $(r+1)$-dimensional space of sections of $\cL_0$ will correspond to a plane $\Lambda \cong \PP^{d-2\delta-r-1} \subset \PP^{d-2\delta}$, meeting each of $g-\delta$ general chords to a rational normal curve in $\PP^{d-2\delta}$. Again, \emph{if} the corresponding Schubert cycles intersect properly, the existence of such planes would imply that
%$$
%r(g-\delta) \leq \dim\GG(d-2\delta-r-1,d-2\delta) = (r+1)(d-r-2\delta),
%$$
%which amounts to the inequality $\rho \geq \delta \geq 0$. 
%
%In sum, we have established the 
%
%\begin{theorem}[Altman-Kleiman] If $\rho(g,r,d)<0$ and 
%the Schubert cycles $\Sigma_r(\overline{p_i,q_i})$ associated to $g$ general chords to a rational normal curve of degree $d$ are dimensionally transverse, then a general curve of genus $g$ will possess no $g^r_d$.
%\end{theorem}
%
%In other words, we have reduced the nonexistence half of classical Brill-Noether to an assertion about general chords to a rational normal curve. This is exactly how
%the Brill-Noether theorem was originally proven, in \cite{Griffiths-Harris-BN}. The proof given there is
%complicated, because the assertion about dimensional transversality
%is \emph{not} true without the hypothesis that the points $p_i,q_i$ are general. For example, if $C$ is a plane conic, and $g=3$, then it is clear that 3 general chords do not meet (and this shows that a general curve of genus 3 is not hyperelliptic!); but there are plenty of triples of concurrent chords---just take three lines through a point off the conic. Fortunately there is an easier way, which we will now explain.
%
%\
%
%\noindent {\bf Step 5: Applying the Pl\"ucker formula}
%
%When trying to prove a statement in algebraic geometry about ``general'' objects of some kind, specialization can sometimes eliminate the hypothesis of generality.
%Though there are triples of concurrent chords to a conic are not concurrent, three tangent lines can never be concurrent! There are many ways to see this, but the one most relevant to our present circumstances is: if the tangent lines to a plane conic $C \subset \PP^2$ met at a point $r \in \PP^2$, then the projection map $\pi_r : C \to \PP^1$ would be a degree 2 map with three or more ramification points, a violation of the Riemann-Hurwitz formula.
%
%This suggests both the statement we should be proving, and how to prove it. 
%
%\begin{lemma}
%Let $C \cong \PP^1 \subset \PP^d$ be a rational normal curve, and $p_1,\dots,p_g \in C$ any $g$ points of $\PP^1$. If $L_i = \overline{2p_i}$ is the tangent line to $C$ at $p_i$, then the Schubert cycles $\Sigma_r(L_i)$ intersect properly; in particular, if $rg > (r+1)(d-r)$, then the intersection $\cap \Sigma_r(L_i)$ is empty.
%\end{lemma}
%
%Note that since tangent lines to a curve are specializations of secant lines, this implies that for $g$ general chords $L_i$ to a rational normal curve, the corresponding Schubert cycles $\Sigma_r(L_i)$ will intersect properly. 
%%\fix{we are using the semicontinuity of fiber dimension in a complete family. Since we seem to be talking to people who don't already know about specialization, we should say a little more about this.} 
%Thus, once we establish the lemma we will have completed the proof of the nonexistence half of Brill Noether.
%
%\begin{proof}
%We will just prove the ``in particular" part here; the more general statement will follow, as we'll indicate in Exercise~\ref{} below.
%
%Suppose $\Lambda \cong \PP^{d-r-1} \subset \PP^d$ is a linear space meeting each of the tangent lines $L_i$, and consider the linear series cut on $\PP^1$ by hyperplanes containing $\Lambda$. The condition that $\Lambda \cap \overline{2p_i} \neq \emptyset$ means exactly that no hyperplane containing $\Lambda$ is transverse to $C$ at $p_i$, or in other words that the linear series $\cD$ cut on $\PP^1$ by hyperplanes containing $\Lambda$ will have ramification sequence at least $(0, 1, 1,\dots,1)$ at $p_i$. Thus the sum of the weights of $\cD$ at the points $p_1,\dots,p_g$ is at least $rg$, and applying the Pl\"ucker formula we arrive at the inequality
%$$
%rg \leq (r+1)(d-r).
%$$
%\end{proof}
%

%
%Now, back to our family $\pi : \cC \to B$ of curves. We have assumed that for some $d$ and $r$ with $\rho(g,r,d) < 0$ the general curve $C_b$ has a $g^r_d$, and deduced that the special fiber $C_0$ has a rank 1 torsion-free sheaf $\cL_0$ of degree $d$ with at least $r+1$ sections; we now have to derive from this a contradiction.
%
%To see most clearly where this contradiction comes from, let's start with the simplest case: where $\cL_0$ is indeed locally free. In this case, let $\nu :  C^\nu \cong \PP^1 \to C$ be the normalization of $C$ and let $q_1,\dots, q_g \in \PP^1$ be the points lying over the cusps of $C_0$. We have
%$$
%\nu^*(\cL) \cong \cO_{\PP^1}(d)
%$$  
%and 
%$$
%V = \nu^*(H^0(\cL_0)) \subset H^0(\cO_{\PP^1}(d))
%$$
%is an $(r+1)$-dimensional space of sections. (If $H^0(\cL_0) > r+1$, just choose any $(r+1)$-dimensional subspace.) 
%
%Now, given that any section $\sigma \in V \subset H^0(\cO_{\PP^1}(d))$ is pulled back from the cuspidal curve $C$, we see that \emph{$\sigma$ cannot vanish to order exactly 1 at the point $q_i \in \PP^1$ lying over any of the cusps of $C_0$}. It follows that for each $i$ the ramification index 
%$$
%\alpha_1(V,q_i) \geq 1 
%$$
%and hence in  general $\alpha_1(q_i,V) \geq 1$ for all $i \geq 1$. In particular, the weight of the inflection point $q_i$ for the linear series $V$ satisfies
%$$
%w(V, q_i) \geq r
%$$
%and correspondingly
%$$
%\sum_{i=1}^g w(V, q_i) \geq rg
%$$
%But the Pl\"ucker formula~\ref{} tells us that the total weight of all inflection points for the series $V$ is
%$$
%\sum_{p \in \PP^1} w(V,p) = (r+1)(d-r)
%$$
%and there's our contradiction: by the hypothesis that 
%$$
%\rho(g,r,d) := g - (r+1)(g-d+r) < 0
%$$
%we have $rg > (r+1)(d-r)$.
%
%Finally, the case where $\cL_0$ is not locally free is if anything even easier. Suppose now that the sheaf $\cL$ fails to be locally free at $l$ of the cusps of $C_0$, say $\nu(p_1),\dots,\nu(p_l)$. Again, we can pull $\cL$ back to $\PP^1$; again we have
%$$
%\nu^*(\cL_0) \cong \cO_{\PP^1}(d);
%$$  
%and again we pull back section of $\cL$ to arrive at a linear system
%$$
%V = \nu^*(H^0(\cL_0)) \subset H^0(\cO_{\PP^1}(d))
%$$
%of degree $d$ and genus $g$ on $\PP^1$. The only difference here is that sections of $V$ all vanish at $p_1,\dots,p_l$, so that we have
%$$
%w(V,p_k) \geq 
%\begin{cases}
%r+1 &\text{ if } k \leq l; \text{ and} \\
%r  &\text{ if } k > l.
%\end{cases}
%$$
%so that
%$$
%\sum_{k=1}^g w(V, p_k) \geq rg + l
%$$
%and our contradiction is even more of a contradiction!

\section{Brill-Noether with inflection}

The approach we've taken here to the proof of Brill-Noether is well-suited to analyzing the inflectionary behavior of linear series on a general curve; indeed, a small modification of the argument above allows us to prove a stronger form of the Brill-Noether statement, concerning the existence of $g^r_d$s on a general curve $C$ that are required to
 have inflection points of given weights.

\begin{definition}
Let $C$ be a smooth curve of genus $g$ and $p_1,\dots,p_n \in C$ distinct points of $C$. If $\cD = (L,V)$ is a linear system on $C$ of degree $d$ and dimension $r$, we define the \emph{adjusted Brill-Noether number} of $\cD$ relative to the points $p_k$ to be
$$
\rho(\cD; p_1,\dots,p_k) := g - (r+1)(g-d+r) - \sum_{k=1}^n w(\cD,p_k).
$$
\end{definition}

%In these terms, our goal will be to prove the following stronger form of the Brill-Noether theorem:

\begin{theorem}\label{Brill-Noether with inflection}
Let $(C;p_1,\dots,p_n)$ be a general $n$-pointed curve of genus $g$ (that is, let $C$ be a general curve and $p_1,\dots,p_n \in C$ general points; equivalently, let $(C;p_1,\dots,p_n)$ correspond to a general point of $M_{g,n}$). If $\cD$ is any linear system on $C$, then
$$
\rho(\cD; p_1,\dots,p_k) \geq 0.
$$
\end{theorem}

%\fix{we should probably call the following a proof sketch}
\begin{proof}
To start, let $\cC \to B$ be a family of curves as in the proof of Lemma~\ref{cusp smoothing lemma}. Let $\sigma_1, \dots, \sigma_n : B \to \cC$ be sections of $\cC \to B$ with $\sigma_k(0)$ a smooth point of $C_0$ for all $k$ (such sections can always be found after passing to an \'etale open neighborhood of $0 \in B$ 
%\fix{but we generally
%stick with the analytic category}. 
Exactly as in the proof of Lemma~\ref{BN in family}, if the general curve $C_b$ in our family admits a $g^r_d$ $\cD$ with
$$
\rho(\cD;\sigma_1(b),\dots,\sigma_n(b)) < 0
$$
we can choose a family $\{\cD_b\}$ of such linear series 
%\fix{needs justification} 
on the fibers $C_b$ for $b \neq 0$ and, taking limits, we arrive at a $g^r_d$ $\cD_0$ on $\PP^1$ with
$$
w(\cD_0, q_i) \geq r
$$
for each of the $g$ points $q_i \in \PP^1$ lying over the cusps of $C_0$, and in addition
$$
w(\cD_0, r_k) \geq w(\cD_b,\sigma_k(b))
$$
where $r_k \in \PP^1$ is the point in $\PP^1$ lying over $\sigma_k(0) \in C_0$. Adding up, we have
\begin{align*}
\sum_{i=1}^g w(\cD_0, q_i) + \sum_{k=1}^n w(\cD_0, r_i) &\geq rg + \sum_{k=1}^n w(\cD_b,\sigma_k(b)) \\
&> rg + g - (r+1)(g-d+r) = (r+1)(d-r)
\end{align*}
since we assumed that 
$$
\rho(\cD_b;\sigma_1(b),\dots,\sigma_n(b)) = g - (r+1)(g-d+r) - \sum_{k=1}^n w(\cD_b,\sigma_k(b)) < 0.
$$
But as before the Pl\"ucker formula for $\PP^1$ tells us that
$$
\sum_{p \in \PP^1} w(\cD_0, p) = (r+1)(d-r),
$$
a contradiction.
\end{proof}

Note that the statement of Theorem~\ref{Brill-Noether with inflection} is an extension of the ``nonexistence" part of Brill-Noether. It raises the question of a converse: if $(C;p_1,\dots,p_n)$ is a general $n$-pointed curve of genus $g$, and we specify ramification sequences $\alpha^1, \dots, \alpha^n$, can we say that there exists a $g^r_d$ $\cD$ on $C$ with $\alpha_i(\cD, p_k) \geq \alpha^k_i$ for $k=1,\dots,n$ and $i = 0, \dots, r$? The answer is that it depends on a Schubert calculus calculation: if the product of the corresponding Schubert classes in $G(d-r, d+1)$ is nonzero, we can indeed assert the existence of such a linear series; and if the product is 0, we can deduce that no such linear series exists.

Here is one way to state what we know without getting lost in the thicket of Schubert calculus:

%%\subsection{Brill-Noether with dimension}
%%
%%Theorem~\ref{Brill-Noether with inflection} might at first glance seem relevant only to problems involving inflection, but in fact in can be used to prove results that have nothing to do with inflection points. For example, one consequence is the stronger form of Brill-Noether:
%%
%%\begin{theorem}\label{BN with dimension}
%%If $C$ is a general curve of genus $g$, then for any $d$ and $r$ with $\rho(g,r,d) \geq 0$,
%%$$
%%\dim W^r_d(C) = \rho(g,r,d).
%%$$
%%\end{theorem}
%%
%%\begin{proof}
%%The idea of the proof is simple: if we had a $(\rho+1)$-dimensional family of $g^r_ds$ on $C$, then we could find one with nonzero ramification at $\rho+1$ general points of $C$, violating Theorem~\ref{Brill-Noether with inflection}. \fix{the equality needs this AND the other inequality, which
%%comes from the determinantal codimension argument}
%%
%%This idea is easier to implement after specializing, so once more we go back to our family $\cC \to B$ of smooth curves specializing to a $g$-cuspidal curve $C_0$, with normalization $\PP^1$. The basic lemma is:
%%
%%\begin{lemma}\label{forced ramification}
%%Let $\Sigma$ be a complete curve and let $\{ \cD_\lambda \}_{\lambda \in \Sigma}$ be a (nonconstant) family of $g^r_ds$ on $\PP^1$ parametrized by $\Sigma$. If $p \in \PP^1$ is any fixed point, then for at least one $\lambda \in \Sigma$ we have $w(\cD_\lambda,p)>0$.
%%\end{lemma}
%%
%%\begin{proof}
%%Embed $\PP^1$ in $\PP^d$ as a rational normal curve of degree $d$. Given a $(d-r-1)$-plane $\Lambda \subset \PP^d$, the hyperplanes in $\PP^d$ containing $\Lambda$ cut out a $g^r_d$ $\cD_\Lambda$ on $\PP^1$, and indeed every $g^r_d$ on $\PP^1$ can be described in this way for a unique $\Lambda$. The $g^r_d$s on $\PP^1$ are thus parametrized by the Grassmannian $\GG(d-r-1,d)$, and we can think of $\Sigma$ as a complete curve in $\GG(d-r-1,d)$.
%%
%%Consider now the hyperplanes $H \subset \PP^d$ such that the divisor $H \cap \PP^1$ has multiplicity $\geq r+1$ at $p$. These correspond to points in a linear space of codimension $r+1$ in $(\PP^d)^*$; in particular, their intersection is an $r$-plane $\Omega \subset \PP^d$, called the \emph{osculating plane} to the rational normal curve at $p$. The condition that a  $g^r_d$ $\cD_\Lambda$ have non-zero ramification at $p$---in other words, that $\cD_\Lambda$ contains a divisor with multiplicity $\geq r+1$ at $p$---is simply that $\Lambda \cap \Omega \neq \emptyset$. But the set of such $\Lambda$ is a hyperplane section of $\GG(d-r-1,d)$ under trhe Pl\"ucker embedding; in particular, any complete curve $\Sigma \subset \GG(d-r-1,d)$ must intersect it.
%%\end{proof}
%%
%%Given this lemma, the proof of Theorem~\ref{BN with dimension} proceeds as follows. We know from the basic dimension estimates of Chapter~\ref{} that $\dim W^r_d(C) \geq \rho(g,r,d)$ for any $C$ \fix{this needs the existence theorem}; we have to show that we cannot have $\dim W^r_d(C) > \rho(g,r,d)$ for a general curve $C$. We argue as follows:
%%
%%First: if it were the case that $\dim W^r_d(C) > \rho(g,r,d)$ for a general curve $C$, we would have, after specializing and pulling back to $\PP^1$, at least a $(\rho + 1)$-dimensional family of $g^r_d$s on $\PP^1$, all of which had ramification weight at least $r$ at the points $q_i$ of $\PP^1$ lying over the cusps of $C_0$. 
%%
%%Secondly, we pick any $\rho + 1$ points $r_k \in \PP^1$ other than the $q_i$. Applying Lemma~\ref{forced ramification} repeatedly, we find that there is at least a $\rho$-dimensional subfamily of $g^r_d$s having nonzero ramification at $p_1$, a $(\rho - 1)$-dimensional subfamily of $g^r_d$s having nonzero ramification at $p_1$ and $p_2$, and so on; ultimately, we conclude that there is a $g^r_d$ $\cD$ on $\PP^1$ with ramification index at least $r$ at each $q_i$ and nonzero ramification index at each $r_k$. 
%%
%%Finally, we observe that the linear series $\cD$ has total ramification at least
%%$$
%%rg + \rho + 1 = (r+1)(d-r)+1
%%$$
%%at the points $q_i$ and $r_k$, once more violating the Pl\"ucker formula.
%%\end{proof}
%
%We can combine Theorem~\ref{BN with dimension} and Theorem~\ref{Brill-Noether with inflection} into one theorem, more complicated but more inclusive:

\begin{theorem}\label{BN with inflection and dimension}
Let $C$ be a smooth curve of genus $g$ and $p_1,\dots,p_n \in C$ distinct points; for $k = 1,\dots,n$ let $\alpha^k = (\alpha^k_0,\dots\alpha^k_r)$ be a nondecreasing sequence of nonnegative integers, and let
$$
G^r_d(p_1,\dots,p_n; \alpha^1,\dots,\alpha^n) = \{\cD \in G^r_d(D) \mid \alpha_i(\cD, p_k) \geq \alpha^k_i \}.
$$
If $(C, p_1,\dots,p_n)$ is a general $n$-pointed curve, then either $G^r_d(p_1,\dots,p_n; \alpha^1,\dots,\alpha^n)$ is empty or
$$
\dim G^r_d(p_1,\dots,p_n; \alpha^1,\dots,\alpha^n) = \rho(g,r,d) - \sum_{k+1}^n \sum_{i=0}^r \alpha^k_i.
$$
\end{theorem}

Finally, we can combine this last theorem with a little dimension-counting to deduce a simple fact:

\begin{theorem}
If $\cD$ is a general $g^r_d$ on a general curve, then $\cD$ has only simple ramification; that is,open 12-	
$$
w(\cD, p) \leq 1 \quad \text{for all } p \in C.
$$
\end{theorem}

Note that applying this in case $d=2g-2$ and $r = g-1$, we arrive at the statement made in Section~\ref{Weierstrass points}: that a general curve $C$ of genus $g$ has only normal Weierstrass points!

\section{Exercises}

\begin{exercise}
Show that in case $r=1$, Theorem~\ref{Plucker} is equivalent to the Riemann-Hurwitz formula for branched covers of $\PP^1$.
\end{exercise}

\begin{exercise}(Buchweitz, unpublished)
Show that there is no curve $C$ (necessarily of genus 16) with a point whose Weierstrasss semigroup
is generated by
$W =\{0,1,2,3,4,5,6,7,8,9,10,11, 18,20,23,24\}$
by showing that the cardinality of $W+W$ is larger than $h^0(2K_C)$.
\end{exercise}

Here is a geometric way to construct a curve $C_0$ by identifying $k$ pairs of points on a smooth curve $C$ of genus $h$: We embed the curve $C$ in projective space by the sections of a line bundle of high degree $d$, and then we project.
%\fix{There is a commented out "Constructing nodal curves"}

\begin{exercise}\label{independent secants} Let $C \subset \PP^N$ be a smooth curve of genus $h$, embedded in projective space by the complete linear system associated to a line bundle $\cL$ of degree $d > 2g + 2k$. Show that any $k+1$ secant or tangent lines to $C$  having pairwise disjoint intersection with $C$ are linearly independent; that is, they span a $\PP^{2k-1}$.
\end{exercise}

Now let $p_1,\dots,p_k, q_1,\dots, q_k \in C$ be any $2k$ distinct points; let $s_i \in \overline{p_i,q_i} \subset \PP^N$ be a general point on the secant line $\overline{p_i,q_i} $, and let $\Lambda \cong \PP^{k-1}$ be the plane spanned by the points $s_1,\dots,s_k$. Let $\pi_\Lambda : \PP^N \to \PP^{N-k}$ be the projection from $\Lambda$, and let $C_0 \subset \PP^{N-k}$ the image $\pi_\Lambda(C)$, and let $r_i = \pi_\Lambda(p_i) = \pi_\Lambda(q_i) \in C_0$.

\begin{exercise}\label{construction of nodal curves}
Using Exercise~\ref{independent secants}, show that 
\begin{enumerate}
\item $\Lambda \cap C = \emptyset$:
\item The map $\pi_\Lambda$ gives an isomorphism between $C \setminus \{p_1,\dots,p_k, q_1,\dots, q_k\}$ and $C_0 \setminus \{r_1,\dots,r_k\}$ (so in particular, $C_0$ is smooth away from the points $r_i$); and
\item The $r_i$ are nodes on $C_0$.
\end{enumerate}
\end{exercise}


\input{footer}