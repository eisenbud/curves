\usepackage{amsmath,amscd,amsthm,amsxtra,latexsym,epsfig,epic,graphicx}
\usepackage[matrix,arrow,curve]{xy}
\usepackage{xcolor}

\def\sfrac#1#2{\vcenter{\offinterlineskip
 \halign{\hfil$\ssty ##$\hfil\cr#1\cr\noalign{\vskip1pt\hrule\vskip1pt}#2\cr}}}
\input preamble.tex

\def\unif{\vspace*{-\parskip}}% uniformize space at end of theorems

\def\thesection{\thechapter\Alph{section}}
\def\thesubsection{\thesection\arabic{subsection}}

\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
%\newtheorem{satz}{Satz}[section]
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{question}[theorem]{Question}
\definecolor{factcolor}{cmyk}{0.5,0.1,0,0}
\def\cbstart{\bgroup\color{factcolor}%
  \hrule width\hsize height3pt\vskip2pt\hrule width\hsize height1pt\vskip1pt
  \egroup}
\def\cbend{\hskip0pt\lower7pt\hbox{}\par\bgroup\color{factcolor}%
  \hrule width\hsize height1pt\vskip2pt\hrule width\hsize height3pt\relax
  \egroup}
\newenvironment{fact}[1][\unskip]
  {\par\goodbreak\begin{npt}\begin{factoid}[#1]
    \vskip3pt\cbstart\normalfont\fontsize{11}{13}\selectfont}
  {\cbend\end{factoid}\end{npt}}
\def\cfword{Cheerful Fact}
\newtheorem{factoid}[theorem]{\cfword}

\def\manyfacts{\def\cfword{Cheerful Facts}% 
% use: \begingroup\manyfacts \begin{fact} \item... \end{fact}\endgroup
  \def\item{\quad$\bullet$\enspace
    \def\item{\par\noindent$\bullet$\enspace}}}

\let\oup\upshape
\newenvironment{npt}{% "no parens thm" used when a thm starts with a citation
  \def\textup##1{{\oup##1}}%
  \gdef\upshape(##1){\oup##1\global\let\upshape\oup} % \upshape is last token
    % in the expansion of \thm@notefont, so this trick strips off the parens
}{}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{notation}[theorem]{Notation}
\newtheorem{thmdef}[theorem]{Theorem-Definition}
\newtheorem{propdef}[theorem]{Proposition-Definition}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{remdef}[theorem]{Remark-Definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{exercise}{Exercise}[chapter]
\def\theexercise{\thechapter\hbox{-}\arabic{exercise}}
\newtheorem{algorithm}[theorem]{Algorithm}
\newtheorem{sub}[subsubsection]{}

\let\dsty\displaystyle \let\tsty\textstyle
\let\ssty\scriptstyle \let\sssty\scriptscriptstyle
% binomial coefficiently with lines not so far apart
%\def\cramped#1{\radical0 {\kern-\nulldelimiterspace#1}}
\def\mbinom#1#2{\Bigl({\tsty{\tsty\medmuskip1mu\hbox{$#1$}\lower2.5pt\hbox{}\atop
      \tsty\medmuskip1mu\smash{#2}\vbox to9pt{}}}\Bigr)}
\def\tbinom#1#2{\bigl(\smash{\tsty{\medmuskip1mu\hbox{$\ssty#1$}\lower3pt\hbox{}\atop
      \medmuskip1mu\raise4pt\hbox{$\ssty#2$}\vbox to9pt{}}}\bigr)}
\def\sbinom#1#2{(\vcenter to0pt{\offinterlineskip\vss\halign{\hfil$\sssty##$\hfil\cr#1\cr\noalign{\vskip1pt}#2\cr}\vss})}

\def\overkern#1#2#3{{}\mskip#1mu\overline{\mskip-#1mu #3\mskip-#2mu}\mskip#2mu{}}
\def\underkern#1#2#3{{}\mskip#1mu\underline{\mskip-#1mu #3\mskip-#2mu}\mskip#2mu{}}

\def\ovD{\overkern31D}
\def\ovR{\overkern31R}

\def\[{[\mskip-3mu[}
\def\]{]\mskip-3mu]}
%\def\lparr{(\mskip-1.5mu(}
%\def\rparr{)\mskip-1.5mu)}

\def\0{$0$}
\def\1{$1$}
\def\2{$2$}
\def\3{$3$}
\def\4{$4$}
\def\5{$5$}
\def\6{$6$}
\def\7{$7$}
\def\8{$8$}
\def\9{$9$}

\hyphenation{
non-zero-divisor non-zero-divisors
hyper-elliptic
homo-morphism homo-morphisms 
homo-geneous
auto-morphism auto-morphisms
}

\def\emdash{\unskip\thinspace---\hskip.16667em\ignorespaces}

% \redden prints its argument in red; an optional argument goes into a
% marginpar.  The {redden} environment is analogous (but doens't prescan).
% We don't need to say \newenvironment{redden}; just defining 
% \redden and \endredden is enough and simplifies some things.

\makeatletter

\newbox\trigabox
\DeclareMathSymbol{\blacktriangleright} {\mathrel}{AMSa}{"49}
\DeclareMathSymbol{\curlyvee}     {\mathbin}{AMSa}{"67}
\DeclareMathSymbol{\curlywedge}   {\mathbin}{AMSa}{"66}
\setbox\trigabox\hbox{\scalebox{0.4}{$\blacktriangleright$}\enspace}
\def\tocsection#1#2#3{%
  \indentlabel{\@ifnotempty{#2}{\rlap{#2}\qquad}}#3}
\def\tocsubsection#1#2#3{%
  \indentlabel{\qquad\raise2.4pt\copy\trigabox\@ifnotempty{#2}{#2\quad}}#3}

\usepackage[nohug,heads=curlyvee]{diagrams}

% \subsubsection was too wimpy in terms of vertical skip and title font.
% It needs to stand out at least as much as a theorem.
\def\subsubsection{\@startsection{subsubsection}{3}%
  \z@{.25\linespacing\@plus.35\linespacing}{-.5em}%
  {\normalfont\itshape\bfseries}}

\def\@marginparreset{\marginparstyle}
\def\marginparstyle{\reset@font\SMALL\normalfont\@setminipage\raggedright\openup-2pt}
\@mparswitchfalse
\long\def \@savemarbox #1#2{%
  \global\setbox #1%
      \vtop{%
        \hsize\marginparwidth
        \@parboxrestore
        \reset@font
        \@setnobreak
        \@setminipage
        \@marginparreset
        \hskip 0pt % otherwise hyphenation of the first word is inhibited 
        #2%
        \par
        \global\@minipagefalse
        }%
}

\DeclareRobustCommand{\redden}{\@ifnextchar*
  {\@latex@error{{redden*} is only an environment}}
  {\@ifnextchar[{\r@dden}{\r@dd@n}}}
\def\r@dden[#1]{\ifmmode\@mperr{math}\else\ifinner\@mperr{inner}%
  \else\leavevmode\marginpar{\leavevmode#1\endgraf}\fi\fi\r@dd@n}
\def\r@dd@n{\def\reserved@a{redden}% Check if being called within environment
  \ifx\@currenvir\reserved@a\redd@n\bgroup\ignorespaces
  \else\expandafter\redd@n\fi}
\def\endredden{\unskip\egroup}
\def\@mperr#1{\@latex@warning{redden in #1 mode: no marginpar possible}}
%\def\redd@n#1{\leavevmode\ifproofs{\color{red}#1}\else
%    \@latex@warning{\string\redden\space suppressed in final version}{#1}\fi}
\def\redd@n#1{\leavevmode{\color{red}#1}}
\def\blue#1{\leavevmode{\color{blue}#1}\marginpar{indexed}}

% The {redden*} environment places a big red star in a marginpar,
% besides printing its contents in red. If there is
% an optional argument, that's the continuation of the marginpar.
\newenvironment{redden*}[1][]
  {\redden[\smash{\color{red}\Large$*$} #1]\bgroup\ignorespaces}
  {\unskip\egroup}

\hyphenpenalty=500

\def\grd{{g^{r}_{d}}}
\def\balpha{{\boldsymbol{\alpha}}}
\def\bbeta{{\boldsymbol{\beta}}}
\def\bdelta{{\boldsymbol{\delta}}}

\DeclareMathOperator{\grade}{\rm grade}
\DeclareMathOperator{\Fitt}{\rm Fitt}
\def\ram{{\operatorname{ram}}}

\def\ruto#1{\mathrel{\hbox{$-\mskip-8mu\to$}%
      \kern-13.5pt
      \raise6pt\hbox{$\scriptstyle#1$}%
      \kern7pt}}
\def\ruuto#1{\mathrel{\hbox{$-\mskip-8mu-\mskip-8mu\to$}%
      \kern-18.5pt
      \raise6pt\hbox{$\scriptstyle#1$}%
      \kern3pt}}

\def\mwedge{\raise1pt\hbox{\small$\bigwedge\mskip-2mu$}}

%%%%%Definitions
\def\TU{{\bf U}}
\def\AA{\mathbb A}
\def\BB{\mathbb B}
\def\QQ{\mathbb Q}
\def\PP{\mathbb P}

\def\facet{{\bf facet}}
\def\image{{\rm image}}
\def\red{{\rm red}}
\def\div{{\rm div}}
\def\cC{\cal C}
\def\cD{{\cal D}}
\def\cE{\cal E}
\def\cF{\cal F}
\def\cG{\cal G}
\def\cH{\cal H}
\def\cP{\cal P}
\def\cW{\cal W}
\def\cK{\cal K}

\def\gb{\beta}
\def\ff{\mathfrak f}
\def\fA{\mathfrak A}
\def\Mor{{\rm Mor}}

\def\ot{\leftarrow}
\def\cHom{\mathcal Hom}
\def\h{{\rm h}}
\newarrow {Dashto} {}{dash}{}{dash}>
\def\rmspan{\operatorname{span}}
\def\ram{\operatorname{ram}}
\def\SL{\operatorname{SL}}
\def\PGL{\operatorname{PGL}}
\def\pic{\operatorname{Pic}}
\def\Div{\operatorname{Div}}
\def\Ann{\operatorname{Ann}}
\def\Res{\operatorname{Res}}

\def\g{\operatorname{\rm g}}
\def\p{\operatorname{\rm p_{a})}}

\def\Sec{\operatorname{Sec}}
\def\sExt{\mathcal Ext}
\def\pd{\operatorname{pd}}

\def\TRR{{Theorem~\ref{RR}}}
\def\bt{{B\'ezout's theorem}}

\newcommand{\ha}{\frac{1}{2}}

\def\Cd{C^{(d)}}
\def\Jac{\operatorname{Jac}}
\def\cW{{\mathcal W}}

\def\op#1#2{{\cO_{\PP^{#1}}(#2)}}
\def\quot{{/\kern-3pt/}}
\makeatletter
\def\Ddots{\mathinner{\mkern1mu\raise\p@
\vbox{\kern7\p@\hbox{.}}\mkern2mu
\raise4\p@\hbox{.}\mkern2mu\raise7\p@\hbox{.}\mkern1mu}}

\def\captionPlus#1#2{\caption[{\protect\footnotesize [#1.pdf]}\quad #2]{#2}}
\def\inprogress{\centerline {\color{red}IN PROGRESS\hfil}\vss\hrule height0pt}

\DeclareRobustCommand\marginparhere[2][0pt]{%
  \ifhmode\unskip\fi
  \ifmmode\ssty\mathclose{\fi %avoid implicit spacing and consequent movement
    \rlap{\hskip\marginparsep\smash{%
      \vtop to 0pt{\marginparstyle \hsize\marginparwidth 
        \leftskip=#1 \rightskip=-#1 plus20pt \noindent#2\vss}}}%
  \ifmmode}\else{} \ignorespaces\fi% avoid glomming onto next word if % follows
}

\AtBeginDocument{\leftmargini=0.5\leftmargini
\belowdisplayshortskip=\belowdisplayskip
\def\smallmath{\def\f@size{9.5}\glb@settings}
\diagramstyle[labelstyle=\smallmath]}

% use when it's necessary for lines to mesh
\newcommand\meshing[1][-1pt]{%
  \lineskiplimit=#1\relax
  \normallineskiplimit=#1\relax
  \lineskip=#1\relax
  \normallineskip=#1\relax
  \advance\jot 1pt %try to compensate for possible squeezing of math alignments
}

\makeatother
